# Модуль чтения и обработки данных ФН для KassArray: руководство пользователя
> **ƒ** &nbsp;RD AAOW FDL; 18.12.2022; 14:44

# 1. Общие сведения

Модуль предназначен для чтения и обработки фискальных данных (ФД) из фискального накопителя (ФН).


Доступные функции:

1. Чтение данных из ФН с помощью физического или виртуального COM-порта и аппаратного адаптера (см. далее).

2. Формирование выгрузки архива ФН в формате `.fnc` в соответствии с Приложением 2 к приказу
ФНС России «Форматы фискальных документов, обязательные к использованию» ***для версии ФФД 1.05***. ***Выгрузки в ФФД 1.1 и 1.2
также реализованы, но находятся в тестировании и могут работать некорректно***.

3. Обработка фискальных данных:
    - Получение полного состояния и всех регистрационных данных ФН;
    - Получение отдельного документа ФН;
    - Получение контрольной ленты за отдельную смену;
    - Получение полного фискального (посменного) отчёта;
    - Получение посменного отчёта по диапазону дат;
    - Прямой запрос счётчиков ФН (для ФФД 1.1 и выше);
    - Расчёт гросс-итогов по данным фискальных документов (для файлов и ФФД 1.05).

4. Сохранение архива ФН в файл в форматах:
    - Двоичных данных (`.fsd`). Это внутренний формат программы, который не может быть использован
при перерегистрации или снятии ККТ с учёта в личном кабинете ФНС. Однако он доступен для последующего открытия и статистической обработки в программе.
    - Табличных данных (`.csv`, доступен для обработки в Microsoft Office Excel).

5. Выполнение обмена с ОФД с параметрами подключения, получаемыми автоматически по данным последней регистрации / перерегистрации, или
с параметрами, соответствующими выбранному ОФД. Обмен включает:
    - Передачу фискальных документов;
    - Передачу уведомлений о реализации маркированного товара;
    - Обновление ключей проверки кодов маркировки.

6. Открытие и закрытие смены, а также закрытие архива ФН текущей датой или датой последнего документа ФН.

7. Чтение и статистическая обработка выгрузок архивов ФН в форматах `.fnc` и `.fsd`.

8. Формирование выгрузки уведомлений о реализации маркированного товара (при работе в автономном режиме)
в формате `.fnm` в соответствии с Приложением 2 к приказу
ФНС России «Форматы фискальных документов, обязательные к использованию» для версии ФФД 1.2 (***находится в тестировании***).

9. Сброс МГМ (для технических целей).


Чтение может быть выполнено тремя способами:
- ***Полное чтение архива***. По его завершении становятся доступными все функции обработки данных.
- ***Прямое чтение ФН***. В этом случае доступны функции чтения статуса ФН и содержимого отдельного документа;
уровень детализации может быть указан пользователем.
- ***Формирование выгрузки .fnc с последующей её загрузкой***. Работает аналогично первому варианту, но набор
реквизитов документов будет неполным, т.к. в файлах выгрузок они хранятся в ограниченном составе.

Независимо от варианта и настроек чтения состояние ФН запрашивается в максимально полном виде.


Детализация чтения может быть:
- ***Полной***. При этом из ФН считываются все TLV-теги (в том числе – неизвестные приложению с представлением
в hex-формате) и квитанции подтверждения ОФД. Может занимать продолжительное время.
- ***Неполной***. Из ФН считываются только известные приложению TLV-теги. По скорости не отличается от предыдущего варианта.
- ***Краткой***. При этом считываются только суммовые счётчики, временны́е метки, номера, фискальные признаки
документов и состояния отправки ОФД. Выполняется быстрее полного считывания примерно в два раза.

Работа программы протестирована на всех моделях ФН из [реестра ФНС](https://nalog.gov.ru/rn77/related_activities/registries/reestr_fiscal).
При соблюдении производителями существующего аппаратного протокола чтения данных работа с будущими моделями ФН также будет возможна.
Однако выгрузка в формате `.fnc` требует дополнительных исследований, в связи с чем модуль может не поддерживать эту функцию
для новейших моделей ФН.


Для выполнения операций с ФН требуется наличие одного из следующих аппаратных адаптеров:
- COM-UART переходник для подключения ФН к разъёму COM (RS-232) компьютера.
- USB-VCOM-UART переходник для подключения к разъёму USB компьютера. В этом случае потребуется установить драйвера устройства;
инструкции и ссылки для их установки предоставляются производителями таких переходников.

Для работы модуля рекомендуется использовать операционную систему Windows 7 или более новую. Функциональность приложения
на Windows XP не проверялась, но потенциально не ограничена. На ПК должна быть установлена среда
[.NET Framework 4.0](https://microsoft.com/ru-ru/download/details.aspx?id=17718) и пакет
[Microsoft VC++ 2010 redistributables](https://microsoft.com/en-us/download/details.aspx?id=26999).

Обращаем внимание, что срок действия каждого релиза модуля ограничен с целью устранения устаревающих версий и обеспечения
его постоянного соответствия актуальным изменениям в ФФД. Срок указан в заголовке операционного окна. По его истечении
останутся доступными функции анализа ранее считанных данных. Для работы с новыми данными необходимо будет получить новый экземпляр приложения.

#

# 2. Начало работы (на примере VCOM-адаптера ООО «РИК»)

## 2.1. Подключение ФН и адаптера к ПК

Перед началом работы необходимо подготовить адаптер к работе. Порядок подключения следующий:
- Убедиться, что адаптер не подключён к ПК или другому источнику питания.
> ***Подключение и отключение ФН при наличии питания на адаптере запрещено! Это может вывести оба устройства из строя!***
- Подключить ФН к адаптеру. Обратите внимание на расположение «ключа» (пропущенного контактного штырька) на разъёмах ФН и адаптера.

![2](https://user-images.githubusercontent.com/20893717/147804726-54c1de33-80ed-4e46-a6a2-6ddd79aa4c51.png)

- Подключить адаптер к ПК.

Отключение по окончании работы с адаптером следует производить в обратном порядке:
- Отключить адаптер от ПК.
- Отключить ФН от адаптера.

> ***Отключение или переподключение адаптера при обращении к нему программы (определяется горящим или мигающим светодиодом
> на адаптере) запрещено! Это может вывести адаптер и ФН из строя!***

Кроме того, при использовании USB-подключения для корректной и стабильной работы рекомендуются короткие соединительные
кабели (не длиннее 20 см) с общим сечением не менее 2,5 мм. Более длинные и / или тонкие кабели могут не обеспечивать
достаточную силу тока для некоторых моделей ФН (проверено на некоторых интерфейсных кабелях, не предназначенных
для зарядки аккумуляторов).

## 2.2. Установка драйвера устройства

После первого подключения адаптера к ПК может потребоваться установка драйвера. Драйвер для устройств FTDI VCP
доступен [здесь](http://www.ftdichip.com/Drivers/VCP.htm). Если драйвер упакован в архив, следует выполнить его распаковку в какую-либо папку.

Далее рассматривается установка драйвера на примере устройства FT230X Basic UART. Для установки драйвера необходимо выполнить следующие действия:
- В меню «Пуск» выбрать пункт «Выполнить» или нажать комбинацию клавиш [Win] + [R].
- Ввести команду «compmgmt.msc» и нажать кнопку «ОК».
- В окне «Управление компьютером» в списке слева выбрать пункт «Диспетчер устройств». В списке устройств найти устройство «FT230X Basic UART»
(будет помечено значком ошибки).

![1](https://user-images.githubusercontent.com/20893717/147804389-f0a87ba5-cbd3-401e-825c-517af186607b.png)

- Щёлкнуть правой кнопкой мыши на этом устройстве и выбрать пункт «Обновить драйверы». В окне варианта установки выбрать «Выполнить поиск
драйверов на этом компьютере». В следующем окне нажать кнопку «Обзор» и указать папку, куда ранее были распакованы драйвера. Нажать кнопку «Далее».
- При необходимости проделать аналогичные манипуляции с устройством «USB Serial Converter» (если оно будет помечено значком ошибки).
- Найти в списке устройств раздел «Порты COM и LPT», а в нём – устройство «USB Serial Port». Запомнить номер порта; он потребуется для работы программы.

#

# 3. Работа с программой

В комплектацию модуля
входят два файла – `KassArrayFN.dll` и `KassArrayLL.dll`. Отсутствие любого из них делает работу модуля невозможной. Запускать следует файл
`KassArray.exe`, из которого следует вызывать функцию «Работа с ФН».

Основной интерфейс модуля представлен на рисунке ниже.

![KAFN2](https://user-images.githubusercontent.com/20893717/208280620-e57a1b9c-9e41-4d23-9d3e-35256b5b4e29.png)

---

## 3.1. Функции, доступные при запуске

С версии 3.2 управляющие кнопки в модуле разведены по функциональным вкладкам. Они будут указаны под заголовками ниже.

### Выбрать номер порта подключения ФН
> Вкладка «Подключение»

Здесь необходимо выбрать порт, который соответствует устройству, появившемуся в системе при установке драйверов
(см. выше). Если подключение устройства выполнено после запуска приложения, можно обновить список системных портов
кнопкой «***Обновить список портов***».

---

### Открыть порт
> Вкладка «Подключение»

Запрашивает статус ФН и, если активен флажок «***и прочитать все документы из ФН***» (активный флажок имеет жёлтый цвет), запускает процесс
считывания данных из ФН. При этом будет отображено окно состояния чтения. На время считывания основное окно программы блокируется.
Если было выполнено полное считывание, по его завершении откроется доступ к аналитическим функциям программы.

![1](https://user-images.githubusercontent.com/20893717/147805842-f85e035f-163b-4dd5-a2f9-ee2248ff0520.png)

Если процесс был прерван, или флажок не был выставлен, аналитика будет недоступна. В обоих случаях станут
активными функции обмена с ОФД, прямого чтения и записи в ФН. Кроме того, модуль позволяет запрашивать (на выбор)
все или только последнюю регистрацию из ФН (флажок «***и только последнюю регистрацию***»).

---

### Открыть файл архива ФН
> Вкладка «Подключение»

Открывает ранее сохранённый файл выгрузки ФН и позволяет выполнять с ним те же манипуляции, что и со считанными
данными, открывая аналитический функционал. Функция поддерживает два формата файлов:
- Собственный формат файла модуля (`.fsd`);
- Эталонный формат архива, создаваемый этой программой, а также программами FNArc, FNRun и FNTransfer (`.fnc`). ***На данный
  момент с выгрузками в ФФД 1.1 и выше проводится тестирование; функционал может быть неполным***.

Эта функция доступна также в варианте *Открыть с помощью*: если для открытия файла дампа из операционной системы выбрать
программу KassArray, она выполнит их загрузку в модуль.

---

### Сформировать файл архива ФН
> Вкладка «Выгрузка данных»

Запускает процесс выгрузки архива ФН в формат `.fnc`, пригодный для передачи в ЛК ФНС при замене ФН, зарегистрированных в автономном режиме.
Эту же функцию можно задействовать, когда требуется получить доступ к аналитике для ФН с большим количеством документов.
При успешном завершении процесса программа загрузит этот файл автоматически.

---

### Сформировать выгрузку уведомлений о реализации маркированных товаров
> Вкладка «Выгрузка данных»

Запускает процесс выгрузки уведомлений в формат `.fnm`, пригодный для передачи в систему «Честный знак», для ФН,
зарегистрированных в автономном режиме.

> ***Функционал находится в тестировании***. Поэтому приложение будет выполнять подтверждение выгрузки –
> необратимую часть процедуры, – только если пользователь согласится на продолжение. Это позволит
> проверить создаваемые файлы на корректность (при отправке в Честный знак).
> Кроме того, создание выгрузки согласно всем правилам по каким-то причинам делает их отличающимися
> и от выгрузок приложения WIN_TEST_FM_1_2 (не совпадает поле CRC при соответствии всех остальных данных),
> и от выгрузок программы FNArc_1_2 (отличается поле «номер последнего уведомления» в заголовке).
> Поэтому проверка выгрузки перед подтверждением на текущий момент ***строго обязательна***!

---

### Изменение уровня детализации считывания
> Вкладка «Прямое чтение ФН»

Переключатель указывает, будет ли выполняться считывание:
- только основных данных документов (флажок имеет зелёный цвет);
- Основных и текстовых данных, а также подтверждений от ОФД и фискальных признаков сообщений (жёлтый цвет);
- всех доступных тегов, в том числе – неизвестных модулю, в представлении hex (оранжевый цвет).

Включение детализации замедляет полный процесс чтения примерно в два раза, но позволяет просмотреть, например, 
наименования товаров и услуг или реквизиты покупателя. Обращаем внимание, что этот переключатель определяет
поведение и функции считывания ФН, и функции прямого доступа к нему.

---

### Отобразить статус ФН
> Вкладка «Статус и счётчики»

Возвращает ранее запрошенный статус ФН в окно статуса приложения. Для этой функции также доступны сохранение в файл
и отправка на принтер.

---

### Ассоциировать форматы файлов
> Вкладка «Прочее»

---

Чтобы назначить модуль в качестве постоянного обработчика форматов `.fnc` и `.fsd`, следует
нажать эту кнопку. При этом необходимо, чтобы все файлы приложения находились в директории, в которой они будут находиться постоянно,
и из которой они не будут перемещены в другое расположение.

---

### Параметры печати документов
> Вкладка «Прочее»

Модуль позволяет отправлять содержимое поля статуса и текстовые отчёты на печать. Кнопка вызывает окно формата бумаги: в качестве
носителя может выступать бумага A4, а также чековая лента 80 мм и 57 мм (при этом используются обычный офисный и чековый принтеры,
соответственно). Кроме того, для чековой ленты доступны обычное и полужирное начертание шрифта (для компенсации яркости печати).

---

### Руководство пользователя
> Вкладка «Прочее»

Открывает данное руководство в браузере по умолчанию.

---

### Горячие клавиши
> Вкладка «Прочее»

Отображает в поле статуса краткую справку по горячим клавишам приложения. Модуль поддерживает набор удобных клавиатурных сокращений
для наиболее часто используемых функций:
- `Ctrl` + `O`: открыть COM-порт и подключить ФН.
- `Shift` + `O`: открыть файл архива ФН.
- `Ctrl` + `D`: сформировать выгрузку архива ФН.
- `Ctrl` + `M`: сформировать выгрузку уведомлений о реализации маркированного товара.
- `Ctrl` + `S`: сохранить считанные данные ФН в другом формате.
- `Ctrl` + `I`: запустить автоматический обмен с ОФД.
- `Shift` + `S`: отобразить статус ФН.
- `Shift` + `C`: запросить счётчики ФН.
- `Ctrl` + `F`: сохранить содержимое поля статуса в файл *с добавлением статуса ФН*.
- `Shift` + `F`: сохранить содержимое поля статуса в файл *без добавления статуса ФН*.
- `Ctrl` + `P`: отправить содержимое поля статуса на принтер *с добавлением статуса ФН*.
- `Shift` + `P`: отправить содержимое поля статуса на принтер *без добавления статуса ФН*.
- `Ctrl` + `H`: запросить данное описание горячих клавиш.

---

## 3.2. Функции, доступные после открытия порта, загрузки файла и в режиме прямого чтения

### Обмен с ОФД
> Вкладка «Обмен с ОФД»

Запускает отправку документов из ФН оператору фискальных данных, если очередь отправки не пуста. Настройки подключения определяются автоматически
(при выборе ***автоматического обмена***): на данный момент для всех ОФД из реестра ФНС имеется однозначное соответствие «ИНН / Название ↔ Host
name / IP + TCP port», которое позволяет избавить пользователя от необходимости ручной настройки соединения. Программе известны настройки связи
со всеми ОФД, действующими на *1 декабря 2022 года*. Тем не менее, выбор ***ручного обмена*** позволяет указать любой неаннулированный ОФД вручную.

В этой же вкладке случае доступен также флажок «***Восстанавливать связь при обрыве***». Если он активен, отправка документов будет циклически
перезапускаться, пока не будет отменена вручную (даже в случае отсутствия выхода в интернет или истечения тарифа ОФД).

При запуске обмена из ФН запрашивается длина очереди отправки и ИНН ОФД, после чего выполняется попытка подключения и передачи. В случае ошибки
модуль сообщает, на каком шаге она происходит. А именно – была ли проблема в подключении, или подключение есть, но ОФД не принимает документ из-за
истечения тарифа. Если связь устанавливается, программа последовательно отправляет все документы из очереди. При необходимости этот процесс можно
прервать. По окончании передачи состояние ФН автоматически перезапрашивается.

Для ФН, зарегистрированных с ФФД 1.2 и признаком торговли маркированными товарами, также выполняется опрос очереди и отправка
уведомлений о реализации маркированных товаров, а также обновление ключей проверки кодов маркировки.

---

### Включить прямое чтение
> Вкладка «Прямое чтение ФН»

Кнопка «***Включить***» имеет оранжевый цвет, когда программа находится в режиме прямого чтения данных, а заголовок окна периодически сметяется
соответствующим сообщением. В этом режиме доступны только функции чтения статуса ФН, а также извлечения отдельного документа.
Полнота считывания данных в этом режиме определяется состоянием расположенного рядом переключателя (см. выше).

Нажатие клавиши [Enter] в поле номера документа для прямого чтения или кнопок «***Запросить***», «***Первый***» и «***Последний***» запускает запрос
документа. В случае двух последних кнопок поле номера получает соответствующее значение.

В этой вкладке доступны также функции сохранения запрошенных данных в файл или отправки их на принтер. В обоих случаях используется
в точности тот текст, который в данный момент находится в поле статуса. С помощью флажка «***Добавить статус ФН***» к этому тексту
можно добавить ранее запрошенный статус, если текст его не содержит.

---

### Получение отчётов
> Вкладка «Отчёты»

После полного считывания или в результате загрузки файла архива ФН становятся доступны функции:
- отдельный документ по номеру;
- контрольная лента за смену по номеру;
- сменные итоги по диапазону дат;
- итоги всех смен из ФН.

Для всех вариантов также доступны сохранение в файл, отправка на принтер и скрытие нулевых сумм.

---

### Сохранение считанных данных в другом формате
> Вкладка «Выгрузка данных»

Эта опция позволяет преобразовать считанные данные или открытые файлы в один из следующих форматов
(выбирается в окне сохранения файла):
- Табличный файл `.csv`, доступный для обработки в Microsoft Office Excel и аналогичных программах.
- Бинарный файл `.fsd`, с которым возможна последующая работа в программе.

В этом случае программа предложит в качестве имени файла комбинацию из заводского номера ФН,
заводского номера ККТ и наименования владельца ККТ.

---

### Запросить счётчики ФН
> Вкладка «Статус и счётчики»

Если ФН был фискализирован с ФФД 1.1 или выше, эта функция позволяет напрямую запросить счётчики накоплений из ФН.
В противном случае опция будет доступна только при полном считывании данных или работе с файлов архива ФН.
Если приложению окажутся доступны оба варианта, пользователь сможет выбрать, каким из них следует воспользоваться.

Флажок «***Только ненулевые значения***» позволяет скрыть поля с нулевыми суммами из запрошенных данных.

Для этой функции также доступны сохранение в файл, отправка на принтер и добавление текста статуса,
если он отсутствует.

---

### Интерактивные функции
> Вкладка «Отчёты»

Эти функции предполагают отображение сведений в поле статуса окна приложения при выполнеии следующих действий:
- При выборе отчёта «*Документ из ФН*» и установке курсора или изменении значения в поле номера документа будет отображено
содержимое соответствующего документа;
- При выборе отчёта «*Контрольная лента за смену*» и установке курсора или изменении значения в поле номера смены будут
отображены итоги соответствующей смены.

---

### Запись в ФН
> Вкладка «Запись в ФН»

Кнопка «***Разрешить***» указывает, можно ли использовать функции, предполагающие запись данных в ФН: сброс МГМ, открытие
и закрытие смены, закрытие архива. Эти функции могут быть удобны, если по какой-либо причине закрытие
смены или архива в ККТ невозможно (например, исчерпание ресурса ФН при открытой смене).

Поскольку ФН не контролирует наличие
непереданных ОФД документов перед выполнением этих операций (за это отвечает ККТ), эти же функции позволяют снять с учёта
ФН с истекшими тарифами ОФД и регистрациями ФНС. Флажок применения даты последнего документа ФН вместо текущей позволяет
снять необходимость в её ручном поиске по документам. 

> ***Если Вы не знаете, зачем нужны эти функции, использовать их и включать эту функцию запрещено. Их применение требует внимания, т.к.
> результаты их работы необратимы. Все перечисленные функции выполняются пользователем на свой страх и риск!***

При успешном завершении этих операций программа автоматически пробует отправить вновь появившиеся документы ОФД, после чего предлагает
перейти в режим прямого чтения для получения их содержимого (с целью последующего сохранения или печати).
